---
title: "Simple Webservices with Plumber"
author: "Stefan Fleck"
date: "11/19/2020"
output: ioslides_presentation
widescreen: true
editor_options: 
  chunk_output_type: console
---

<style>
div.footer {
  position: absolute;
  bottom: 0;
  margin-bottom: 10px;
  width: 80%;
  font-size: 0.6em;
}

.forceBreak { -webkit-column-break-after: always; break-after: column; }
</style>


```{r setup, include=FALSE}
library(here)
library(httr)
library(magrittr)
library(leaflet)
library(leaflet.extras)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```
## Outline

1. Processing location data
2. Why a web service?
3. Architecture and Code examples
4. Conclusion



# Geoprocessing

## Travel distance from position data {.columns-2 .smaller}

- The app provides:
    - Geo-position every x seconds (varies by device)
    - Positional accuracy
    - Speed

- Quality of data varies (gaps, outliers)
- Pre-processing necessary
- Imputation of gaps necessary (via routing)

<p class="forceBreak"></p>

```{r}
create_map <- function(x, hideGroup = "Route", attributionControl = FALSE){
  leaflet::leaflet(
    options = leaflet::leafletOptions(
      preferCanvas = TRUE, 
      zoomControl = FALSE,
      attributionControl=attributionControl
    )
  )  %>%
  leaflet::addProviderTiles(provider = "CartoDB.Positron") %>%
  leaflet::hideGroup(hideGroup) %>%
  leaflet::addCircles(
    data = x$points,
    color = "crimson",
    radius = 1,
    group = "Punkte"
  ) %>%
  leaflet::addPolylines(
    data = x$sf, 
    group = "Route"
  )
}
```

Outliers
```{r out.width = "100%", out.height="200px"}
x1 <- readRDS(here("data/brunn-am-gebirge_klagenfurt-am-woerthersee.rds"))
create_map(x1, hideGroup = "Route") %>% 
  leaflet::setView(15.28,  47.407, 14) %>% 
  leaflet.extras::addFullscreenControl()
```

Gaps
```{r out.width = "100%", out.height="200px"}
x2 <- readRDS(here("data/gross-enzersdorf_simmering.rds"))
create_map(x2, hideGroup = "Route", attributionControl = TRUE)
```


## Travel distance from position data II {data-background=img/cogwheels-bg.svg data-background-size=cover}

1. Remove points where
    - position accuracy is less than 20m
    - reported speed is less than 7kph (walking)
    - calculated speed is greater than 130kph (outliers)
2. Connect points that are close together with straight lines
3. Use external routing service to connect points further than 50m apart


<div class="footer"> 
*reported speed*: Speed according to speed sensor of the device

*calculated speed*: Speed calculated from position & timestamp
</div>


# Why a web service

## How do we integrate our R code in production?

Problem: A new journey can be submitted at any time of the day and needs to 
be processed within minutes


> * Manually execute the script each time we receive a new journey
>
> * Make an R-Script that is callable from the the command line 
>
>     * Pushes responsibility for maintianing the R environment to the IT department
>     * IT Department needs to be involved for all changes to the script 
>      
> * Set-up a web-service (with plumber)!
>     - can be developed completely independent from the APP development team
>     - updating and testing ist (relatively) easy

# Architecture & Code examples

## Architecture
<div class = "columns-2" style="font-size:20px">

  * Mobile-App communicates with Backend
  * Backend communicates with geoprocessing service
  * Geoprocessing service communicates with external routing service
  
  Each component can easily be replaced as long as the API stays stable!
  
  <p class="forceBreak"></p>
  
  <center><img src="img/mobile-app-architecture-2.svg"></center>

</div>

<div class="footer" style = "width:50%"> 
*Web Service*: A service that runs on a server and responds to requests (usually via HTTP) 
*HTTP*: A protocol for computers to communicate with each other
  
*API*: Application Programming Interface: A part of a program that enables it to communicate with other programs
</div>



## Server code {.smaller}

```{r echo = TRUE, eval = FALSE}
#* Calculate the fastest route 
#* @param ride_id integer id 
#* @response 400 Impossible Route Rrror: routing not possible (e.g. Islands)
#* @response 504 Gateway Timeout Error: routing backend may be down.
#*
#* @get /v1/rides/<id>/summary
rides_summary <- function(
  id = "",  # from the path definition above
  res   # special plumber object: the Response
){
  r <- tryCatch({
    calculate_fastest_route(id)
  },
    impossible_route_error = function(e){res$status <- 400},
    gateway_timeout_error = function(e){res$status <- 504}
  )

  r
}
```


<div class="footer" style = "width:50%"> 
<span style="font-size:0.6em">[HTTP status codes](https://tools.ietf.org/html/rfc7231#section-6)</span>
</div>

## Client code {.smaller}

real examples (will only work inside STAT)
https://rsconnect.statistik.local/sgvkappd/v1/rides/ex5/summary


```{r echo = TRUE, eval = FALSE}
res <- httr::GET("https://<...>/rides/12345/summary")
httr::content(res)

## $distanceAustria
## [1] 297334.3
## 
## $distanceForeign
## [1] 0
```


# Conclusion


## Further reading {.smaller}

[plumber: An API Generator for R](https://www.rplumber.io/)

[httr: Tools for Working with URLs and HTTP](https://github.com/r-lib/httr)

[HTTP: The Protocol Every Web Developer Must Know](https://code.tutsplus.com/tutorials/http-the-protocol-every-web-developer-must-know-part-1--net-31177)

[Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content](https://tools.ietf.org/html/rfc7231)

The Austrian Road Freight Transport Mobile App
[video](https://www.youtube.com/watch?v=_RpJUSiBZaI&feature=youtu.be) or
[brochure](https://www.statistik.at/wcm/idc/idcplg?IdcService=GET_PDF_FILE&dDocName=122327) [in German]

 
[This presentation](https://github.com/s-fleck/simple-webservices-with-plumber-uros2020)


### Contact


[stefan.fleck@statistik.gv.at](mailto:stefan.fleck@statistik.gv.at)

[https://github.com/s-fleck](https://github.com/s-fleck)


