---
title: "Simple Webservices with Plumber"
author: "Stefan Fleck"
date: "11/19/2020"
output: ioslides_presentation
widescreen: true
editor_options: 
  chunk_output_type: console
---

<style>
div.footer {
  position: absolute;
  bottom: 0;
  margin-bottom: 10px;
  width: 80%;
  font-size: 0.6em;
}

.forceBreak { -webkit-column-break-after: always; break-after: column; }
</style>


```{r setup, include=FALSE}
library(here)
library(httr)
library(magrittr)
library(leaflet)
library(leaflet.extras)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```


## Travel distance from position data {.columns-2 .smaller}


- What we need: 
     - Total distance of the journey
     - Transitioned countries
     - Border crossings
- What the mobile app provides:
    - Geographic position every x seconds
    - Actual frequency depends on device 
    - Accuracy varies by device and field-conditions (e.g tunnels block the GPS signal)


<p class="forceBreak"></p>

<div class="notes">

- [explain map in detail]
  - show tunnels
  - highlight outliers
  - comment on temporal resolution of the position data
  
</div>


```{r}
create_map <- function(x, hideGroup = "Route"){
  leaflet::leaflet(
    options = leaflet::leafletOptions(
      preferCanvas = TRUE, 
      zoomControl = FALSE
    )
  )  %>%
  addFullscreenControl() %>% 
  leaflet::addProviderTiles(provider = "CartoDB.Positron") %>%
  leaflet::hideGroup(hideGroup) %>%
  leaflet::addLayersControl(
    overlayGroups = c("Route", "Punkte")
  ) %>% 
  leaflet::addCircles(
    data = x$points,
    color = "crimson",
    radius = 1,
    group = "Punkte"
  ) %>%
  leaflet::addPolylines(
    data = x$sf, 
    group = "Route"
  )
}
```

```{r out.width = "100%", out.height="250px"}
x1 <- readRDS(here("data/brunn-am-gebirge_klagenfurt-am-woerthersee.rds"))
create_map(x1, hideGroup = "Route")
```
<br>
```{r out.width = "100%", out.height="250px"}
x2 <- readRDS(here("data/gross-enzersdorf_simmering.rds"))
create_map(x2, hideGroup = "Route")
```



## The solution {data-background=img/cogwheels-bg.svg data-background-size=cover}

1. Remove points where
    - position accuracy is less than 20m
    - reported speed is less than 7kph (walking)
    - calculated speed is greater than 130kph (outliers)
2. Use external routing service to connect points further than 50m apart
3. Discard unrealistic routes (calculated speed for segment greater 130kph)
4. Connect remaining points with straight lines

<div class="footer"> 
*reported speed*: Speed according to speed sensor of the device

*calculated speed*: Speed calculated from position & timestamp
</div>

## Thank you for your attention! {.flexbox .vcenter .build}

<div>The End</div><div>?</div><div>?????????????????????</div>


## How do we integrate our R code in production?

Problem: A new journey can be submitted at any time of the day and needs to 
be processed within minutes


> * Manually execute the script each time we receive a new journey
>
> * Make an R-Script that is callable from the the command line 
>
>     * Pushes responsibility for maintianing the R environment to the IT department
>     * IT Department needs to be involved for all changes to the script 
>     * Testing the script impractical (automated tests)
>      
> * Set-up a web-service (with plumber)!
>     - can be developed completely independent from the APP development team
>     - updating and testing ist (relatively) easy



## What is... {.build}

<div>
- a *Web Service*: A service that runs on a server and responds to requests (usually via HTTP)
</div>

<div>
- *HTTP*: A protocol for computers to communicate with each other
</div>

<div>
- an *API*: Application Programming Interface: A part of a program that enables it to
    communicate with other programs
</div>

<div>
-  REST: Representational state transfer: An architecture standard for web services
</div>



## Architecture {.columns-2 .smaller}

* Mobile-App communicates with Backend
* Backend communicates with geoprocessing service
* Geoprocessing service communicates with external routing service

Each component can easily be replaced as long as the API stays stable!

<p class="forceBreak"></p>

<center><img src="img/mobile-app-architecture-2.svg"></center>


## How is it useful?

## Code examples {.smaller}

```{r echo = TRUE, eval = FALSE}
#* Calculate the fastest route 
#* @param ride_id integer id 
#* @response 400 Impossible Route Rrror: routing not possible (e.g. Islands)
#* @response 504 Gateway Timeout Error: routing backend may be down.
#*
#* @get /v1/rides/<id>/summary
rides_summary <- function(
  id = "",  # from the path definition above
  res   # special plumber object: the Response
){
  r <- tryCatch({
    calculate_fastest_route(id)
  },
    impossible_route_error = function(e){res$status <- 400},
    gateway_timeout_error = function(e){res$status <- 504}
  )

  r
}
```

## Advantages

- Code 
- API is universal: Client and Server code can bei maintained and modified
independent of each other




## Code examples {.smaller}

real examples (will only work inside STAT)
https://rsconnect.statistik.local/sgvkappd/v1/rides/ex5/summary


```{r echo = TRUE, eval = FALSE}
res <- httr::GET("https://<...>/rides/12345/summary")
httr::content(res)

## $distanceAustria
## [1] 297334.3
## 
## $distanceForeign
## [1] 0
```


## The most important HTTP requests:

* `GET`
* `PUT`
* `DELETE`
* `POST`


<div class="footer"> 
[HTTP Methods](https://tools.ietf.org/html/rfc7231#section-4) 
</div>


## HTTP Status codes


```{r echo = TRUE, eval = FALSE}
#* @get /v1/rides/<id>/summary
rides_summary <- function(
  id = "",  # from the path definition above
  res   # special plumber object: the Response
){
  r <- tryCatch({
    calculate_fastest_route(id)
  },
    impossible_route_error = function(e){res$status <- 400},
    gateway_timeout_error = function(e){res$status <- 504}
  )
  r
}
```

* 200
* 400 Client Error:
* 500 Server Error:
400 errors tell the client, that something is wrong with his request
500 errors tell the client, that something is wrong with the server



<div class="footer"> 
[HTTP Status codes](https://tools.ietf.org/html/rfc7231#section-6)
</div>


## Pitfalls of plumber

  * v.1.0.0 was released this year (2020) but still some rough edges
  * documentation lacking

## Further reading {.smaller}

[plumber: An API Generator for R](https://www.rplumber.io/)

[httr: Tools for Working with URLs and HTTP](https://github.com/r-lib/httr)

[HTTP: The Protocol Every Web Developer Must Know](https://code.tutsplus.com/tutorials/http-the-protocol-every-web-developer-must-know-part-1--net-31177)

[Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content](https://tools.ietf.org/html/rfc7231)

The Austrian Road Freight Transport Mobile App
[video](https://www.youtube.com/watch?v=_RpJUSiBZaI&feature=youtu.be) or
[brochure](https://www.statistik.at/wcm/idc/idcplg?IdcService=GET_PDF_FILE&dDocName=122327) [in German]

 
[This presentation](https://github.com/s-fleck/simple-webservices-with-plumber-uros2020)

