---
title: "Simple Webservices with Plumber"
author: "Stefan Fleck"
date: "11/19/2020"
output: ioslides_presentation
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(here)
library(httr)
library(magrittr)
library(leaflet)
library(leaflet.extras)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

## R Markdown



## The Problem:


```{r}
dd <- readRDS(here("data/brunn-am-gebirge_klagenfurt-am-woerthersee.rds"))

leaflet::leaflet(options = leaflet::leafletOptions(preferCanvas = TRUE))  %>%
  addFullscreenControl() %>% 
  leaflet::addProviderTiles(provider = "CartoDB.Positron") %>%
  leaflet::hideGroup("Route") %>%
  leaflet::addLayersControl(
    overlayGroups = c("Route", "Punkte")
  ) %>% 
  leaflet::addCircles(
    data = dd$points,
    color = "crimson",
    radius = 1,
    group = "Punkte"
  ) %>%
  leaflet::addPolylines(
    data = dd$sf, 
    group = "Route"
  )


```


## How do we 

* Manually call the script each time we receive a new router?
  - impractical
* Call an R script from the command line
  - 
* Use a web-service!


## What is a Web Service?

* A service that runs on a server and responds to requests
* Makes it possible 

```

client <-HTTP-> server

```


## What is a RESTful API

* API: Application Interface (as upposed to User Interface)
* REST: Representational state transfer (REST) is Standard for creating webservices.


## How is it useful?

## Code examples
```{r echo = TRUE, eval = FALSE}
#* Calculate route paramters
#* @param ride_id integer id 
#* @response 400 Impossible Route Rrror: routing not possible (e.g. Islands)
#* @response 503 Service Unavailable Error: Likely too many requests to routing-backend, please try again later
#* @response 504 Gateway Timeout Error: routing backend may be down.
#* @response 200 a JSON object containing distanceAustria, distanceForeign
#*
#* @get /v1/rides/<id>/summary
rides_summary <- function(
  id = "",  # from the path definition above
  req,  # special plumber object: the Request
  res   # special plumber object: the Response
){
  r <- tryCatch({
    calculate_fastest_route(id)
  },
    impossible_route_error = function(e){res$status <- 400},
    service_unavailable_error = function(e){res$status <- 503},
    gateway_timeout_error = function(e){res$status <- 504}
  )

  r
}
```

```{r echo = TRUE, eval = FALSE}
res <- httr::GET("https://<...>/rides/12345/summary")
httr::content(res)

## $distanceAustria
## [1] 297334.3
## 
## $distanceForeign
## [1] 0
```

real examples (will only work inside STAT)
https://rsconnect.statistik.local/sgvkappd/v1/rides/ex5/summary
https://rsconnect.statistik.local/sgvkappd/v1/rides/ex5/map

## Pitfalls of plumber

  * v.1.0.0 was released this year (2020) but still some rough edges
  * documentation lacking

## Further reading

* plumber: https://github.com/rstudio/plumber
* httr: https://github.com/r-lib/httr
* HTTP Methods explained: https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html
